"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports["default"]=void 0;var _regenerator=_interopRequireDefault(require("@babel/runtime/regenerator"));var _asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));var _createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass"));var _path=_interopRequireDefault(require("path"));var _Reference=_interopRequireDefault(require("./../Reference"));var _PackageReference=_interopRequireDefault(require("./../PackageReference"));var _TagReference=_interopRequireDefault(require("./../TagReference"));var _Definition=_interopRequireDefault(require("./../Definition"));var _validateNpmPackageName=_interopRequireDefault(require("validate-npm-package-name"));var _Autowire=_interopRequireDefault(require("../Autowire"));function _createForOfIteratorHelper(o,allowArrayLike){var it=typeof Symbol!=="undefined"&&o[Symbol.iterator]||o["@@iterator"];if(!it){if(Array.isArray(o)||(it=_unsupportedIterableToArray(o))||allowArrayLike&&o&&typeof o.length==="number"){if(it)o=it;var i=0;var F=function F(){};return{s:F,n:function n(){if(i>=o.length)return{done:true};return{done:false,value:o[i++]};},e:function e(_e){throw _e;},f:F};}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.");}var normalCompletion=true,didErr=false,err;return{s:function s(){it=it.call(o);},n:function n(){var step=it.next();normalCompletion=step.done;return step;},e:function e(_e2){didErr=true;err=_e2;},f:function f(){try{if(!normalCompletion&&it["return"]!=null)it["return"]();}finally{if(didErr)throw err;}}};}function _unsupportedIterableToArray(o,minLen){if(!o)return;if(typeof o==="string")return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);if(n==="Object"&&o.constructor)n=o.constructor.name;if(n==="Map"||n==="Set")return Array.from(o);if(n==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return _arrayLikeToArray(o,minLen);}function _arrayLikeToArray(arr,len){if(len==null||len>arr.length)len=arr.length;for(var i=0,arr2=new Array(len);i<len;i++){arr2[i]=arr[i];}return arr2;}var FileLoader=function(){function FileLoader(container){(0,_classCallCheck2["default"])(this,FileLoader);this._container=container;}(0,_createClass2["default"])(FileLoader,[{key:"container",get:function get(){return this._container;}},{key:"filePath",get:function get(){return this._filePath;},set:function set(value){this._filePath=value;}},{key:"_parseDefinitions",value:function(){var _parseDefinitions2=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee(){var services,id,_args=arguments;return _regenerator["default"].wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:services=_args.length>0&&_args[0]!==undefined?_args[0]:[];_context.t0=_regenerator["default"].keys(services);case 2:if((_context.t1=_context.t0()).done){_context.next=13;break;}id=_context.t1.value;if(!(id==='_defaults')){_context.next=9;break;}_context.next=7;return this._parseDefaults(services._defaults);case 7:_context.next=11;break;case 9:_context.next=11;return this._parseDefinition(services,id);case 11:_context.next=2;break;case 13:case"end":return _context.stop();}}},_callee,this);}));function _parseDefinitions(){return _parseDefinitions2.apply(this,arguments);}return _parseDefinitions;}()},{key:"_parseDefinition",value:function(){var _parseDefinition2=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee2(services,id){var service;return _regenerator["default"].wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:service=services[id];if(typeof service==='string'){this.container.setAlias(id,service.slice(1));}else if(service.factory){this.container.setDefinition(id,this._getFactoryDefinition(service));}else{this.container.setDefinition(id,this._getDefinition(service));}case 2:case"end":return _context2.stop();}}},_callee2,this);}));function _parseDefinition(_x,_x2){return _parseDefinition2.apply(this,arguments);}return _parseDefinition;}()},{key:"_getFactoryDefinition",value:function _getFactoryDefinition(service){var object=null;if(service.factory["class"].includes('@',0)){object=new _Reference["default"](service.factory["class"].slice(1));}else{object=this._requireClassNameFromPath(service.factory["class"]);}var definition=new _Definition["default"]();definition.shared=service.shared;definition.setFactory(object,service.factory.method);definition.args=this._getParsedArguments(service.arguments);return definition;}},{key:"_getDefinition",value:function _getDefinition(service){var definition;if(!service.synthetic){var object=this._requireClassNameFromPath(service["class"],service.main);definition=new _Definition["default"](object);definition.lazy=service.lazy||false;definition["public"]=service["public"]!==false;definition["abstract"]=service["abstract"]||false;definition.parent=service.parent;definition.decoratedService=service.decorates;definition.decorationPriority=service.decoration_priority;definition.deprecated=service.deprecated;definition.shared=service.shared;this._parseArguments(definition,service.arguments);this._parseProperties(definition,service.properties);this._parseCalls(definition,service.calls);this._parseTags(definition,service.tags);}else{definition=new _Definition["default"]();definition.synthetic=true;}return definition;}},{key:"_parseCalls",value:function _parseCalls(definition){var _this=this;var calls=arguments.length>1&&arguments[1]!==undefined?arguments[1]:[];calls.forEach(function(call){definition.addMethodCall(call.method,_this._getParsedArguments(call.arguments));});}},{key:"_parseTags",value:function _parseTags(definition){var tags=arguments.length>1&&arguments[1]!==undefined?arguments[1]:[];tags.forEach(function(tag){definition.addTag(tag.name,FileLoader._parseTagAttributes(tag.attributes));});}},{key:"_getParsedArguments",value:function _getParsedArguments(){var args=arguments.length>0&&arguments[0]!==undefined?arguments[0]:[];var parsedArguments=[];var _iterator=_createForOfIteratorHelper(args),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var argument=_step.value;parsedArguments.push(this._parseArgument(argument));}}catch(err){_iterator.e(err);}finally{_iterator.f();}return parsedArguments;}},{key:"_parseDefaults",value:function(){var _parseDefaults2=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee3(){var defaults,filePathParsed,autowire,_args3=arguments;return _regenerator["default"].wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:defaults=_args3.length>0&&_args3[0]!==undefined?_args3[0]:{};if(!(!defaults||!defaults.autowire)){_context3.next=3;break;}return _context3.abrupt("return");case 3:if(!_path["default"].isAbsolute(defaults.rootDir)){filePathParsed=_path["default"].parse(this.filePath);this._container.defaultDir=_path["default"].join(filePathParsed.dir,defaults.rootDir);}else{this._container.defaultDir=defaults.rootDir;}autowire=new _Autowire["default"](this._container);if(defaults.exclude&&Array.isArray(defaults.exclude)){defaults.exclude.forEach(function(exclude){autowire.addExclude(exclude);});}_context3.next=8;return autowire.process();case 8:case"end":return _context3.stop();}}},_callee3,this);}));function _parseDefaults(){return _parseDefaults2.apply(this,arguments);}return _parseDefaults;}()},{key:"_parseProperties",value:function _parseProperties(definition){var properties=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};for(var propertyKey in properties){definition.addProperty(propertyKey,this._parseArgument(properties[propertyKey]));}}},{key:"_parseImports",value:function(){var _parseImports2=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee4(){var imports,_iterator2,_step2,file,workingPath,_args4=arguments;return _regenerator["default"].wrap(function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:imports=_args4.length>0&&_args4[0]!==undefined?_args4[0]:[];_iterator2=_createForOfIteratorHelper(imports);_context4.prev=2;_iterator2.s();case 4:if((_step2=_iterator2.n()).done){_context4.next=12;break;}file=_step2.value;workingPath=this.filePath;_context4.next=9;return this.load(_path["default"].join(_path["default"].dirname(this.filePath),file.resource));case 9:this.filePath=workingPath;case 10:_context4.next=4;break;case 12:_context4.next=17;break;case 14:_context4.prev=14;_context4.t0=_context4["catch"](2);_iterator2.e(_context4.t0);case 17:_context4.prev=17;_iterator2.f();return _context4.finish(17);case 20:case"end":return _context4.stop();}}},_callee4,this,[[2,14,17,20]]);}));function _parseImports(){return _parseImports2.apply(this,arguments);}return _parseImports;}()},{key:"_parseParameters",value:function(){var _parseParameters2=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee5(){var parameters,key,_args5=arguments;return _regenerator["default"].wrap(function _callee5$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:parameters=_args5.length>0&&_args5[0]!==undefined?_args5[0]:{};for(key in parameters){this._container.setParameter(key,parameters[key]);}case 2:case"end":return _context5.stop();}}},_callee5,this);}));function _parseParameters(){return _parseParameters2.apply(this,arguments);}return _parseParameters;}()},{key:"_parseArguments",value:function _parseArguments(definition){var args=arguments.length>1&&arguments[1]!==undefined?arguments[1]:[];var argument=definition["abstract"]?'appendArgs':'args';definition[argument]=this._getParsedArguments(args);}},{key:"_parseArgument",value:function _parseArgument(argument){if(typeof argument==='boolean'){return argument;}if(argument.slice(0,2)==='@?'){return new _Reference["default"](argument.slice(2),true);}else if(argument.slice(0,1)==='@'){return new _Reference["default"](argument.slice(1));}else if(argument.slice(0,1)==='%'&&argument.slice(-1)==='%'){return this._getArgumentParameter(argument);}else if(argument.slice(0,1)==='%'){return new _PackageReference["default"](argument.slice(1));}else if(argument.slice(0,7)==='!tagged'){return new _TagReference["default"](argument.slice(8));}return argument;}},{key:"_getArgumentParameter",value:function _getArgumentParameter(argument){if(argument.slice(1,4)==='env'){return process.env[argument.slice(5,-2)];}else{return this._container.getParameter(argument.slice(1,-1));}}},{key:"_requireClassNameFromPath",value:function _requireClassNameFromPath(classObject,mainClassName){var fromDirectory=!_path["default"].isAbsolute(classObject)?_path["default"].dirname(this.filePath):'/';fromDirectory=this.container.defaultDir||fromDirectory;var exportedModule=null;try{exportedModule=require(_path["default"].join(fromDirectory,classObject));}catch(error){if(error.code==='MODULE_NOT_FOUND'&&(0,_validateNpmPackageName["default"])(classObject)){exportedModule=require(classObject);}else{throw error;}}var mainClass=exportedModule[mainClassName];var defaultClass=exportedModule["default"];var fileNameClass=exportedModule[_path["default"].basename(classObject)];return mainClass||defaultClass||fileNameClass||exportedModule;}}],[{key:"_parseTagAttributes",value:function _parseTagAttributes(attributes){var map=new Map();if(attributes){for(var _i=0,_Object$keys=Object.keys(attributes);_i<_Object$keys.length;_i++){var key=_Object$keys[_i];map.set(key,attributes[key]);}}return map;}}]);return FileLoader;}();var _default=FileLoader;exports["default"]=_default;